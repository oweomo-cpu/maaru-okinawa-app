<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã¾ãƒ¼ã‚‹æ²–ç¸„ â€“ é§è»Šå ´ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ocean:  { DEFAULT: '#0077B6', light: '#00B4D8', pale: '#CAF0F8' },
            sky:    { DEFAULT: '#48CAE4', pale: '#E0F7FF' },
            coral:  '#FF6B6B',
            sandy:  '#FFF3CD',
            leaf:   '#2DC653',
          },
          fontFamily: {
            sans: ['"Noto Sans JP"', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" />
  <style>
    /* ã‚²ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fillBar {
      from { width: 0; }
      to   { width: var(--target-width); }
    }
    .fill-bar { animation: fillBar 1s ease-out forwards; }

    /* ã‚«ãƒ¼ãƒ‰æµ®ãä¸ŠãŒã‚Šã‚·ãƒ£ãƒ‰ã‚¦ */
    .card-shadow {
      box-shadow: 0 8px 32px rgba(0,119,182,0.12);
    }

    /* ç©´å ´ã‚¨ãƒªã‚¢ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }

    /* ç‚¹æ»…ã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæº€è»Šæ™‚ï¼‰ */
    @keyframes blink {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.3; }
    }
    .blink { animation: blink 1.2s ease-in-out infinite; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-sky-pale via-white to-ocean-pale font-sans">

  <!-- â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ -->
  <header class="bg-gradient-to-r from-ocean to-ocean-light shadow-md">
    <div class="max-w-xl mx-auto px-4 py-5 flex items-center gap-3">
      <!-- æ³¢ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆSVG ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰-->
      <svg class="w-10 h-10 text-white flex-shrink-0" viewBox="0 0 48 48" fill="none"
           xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="24" cy="24" r="22" fill="rgba(255,255,255,0.2)"/>
        <path d="M8 28 Q14 22 20 28 Q26 34 32 28 Q38 22 44 28"
              stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
        <path d="M8 20 Q14 14 20 20 Q26 26 32 20 Q38 14 44 20"
              stroke="rgba(255,255,255,0.6)" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      </svg>
      <div>
        <h1 class="text-white text-2xl font-black tracking-wide leading-tight">ã¾ãƒ¼ã‚‹æ²–ç¸„</h1>
        <p class="text-sky-pale text-sm font-medium leading-tight">é§è»Šå ´ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ±</p>
      </div>
      <!-- è‡ªå‹•æ›´æ–°ãƒœã‚¿ãƒ³ -->
      <button id="refreshBtn" onclick="loadAll()"
              class="ml-auto bg-white/20 hover:bg-white/30 active:scale-95 text-white text-sm
                     font-bold px-4 py-2 rounded-full transition-all flex items-center gap-1.5">
        <svg id="refreshIcon" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd"
                d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002
                   5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1
                   1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1
                   1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                clip-rule="evenodd"/>
        </svg>
        æ›´æ–°
      </button>
    </div>
  </header>

  <!-- â”€â”€ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â”€â”€ -->
  <main class="max-w-xl mx-auto px-4 py-6 space-y-5">

    <!-- èª­ã¿è¾¼ã¿ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ -->
    <div id="loadingArea" class="flex flex-col items-center py-16 gap-4">
      <div class="w-14 h-14 border-4 border-ocean/30 border-t-ocean rounded-full animate-spin"></div>
      <p class="text-ocean text-lg font-bold">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­â€¦</p>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div id="errorArea" class="hidden bg-red-50 border border-red-200 rounded-2xl p-5 text-center">
      <p class="text-2xl mb-2">âš ï¸</p>
      <p class="text-red-700 font-bold text-lg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
      <p id="errorMsg" class="text-red-500 text-sm mt-1"></p>
      <button onclick="loadAll()"
              class="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-2 rounded-full text-sm transition-colors">
        å†èª­ã¿è¾¼ã¿
      </button>
    </div>

    <!-- é§è»Šå ´ã‚«ãƒ¼ãƒ‰ç¾¤ï¼ˆJS ã§ç”Ÿæˆï¼‰ -->
    <div id="cardsArea" class="hidden space-y-4"></div>

    <!-- ç©´å ´ã‚¹ãƒãƒƒãƒˆï¼ˆä¸¡æ–¹80%ä»¥ä¸Šã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
    <div id="honeSpotArea" class="hidden fade-in-down"></div>

    <!-- æœ€çµ‚æ›´æ–° -->
    <div id="updatedArea" class="hidden text-center text-gray-400 text-sm pb-4">
      <span id="updatedText"></span>
    </div>

  </main>

  <!-- â”€â”€ ãƒ•ãƒƒã‚¿ãƒ¼ â”€â”€ -->
  <footer class="text-center text-xs text-gray-400 pb-6 px-4">
    <p>ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å–å¾—ã§ã™ã€‚æ­£ç¢ºãªæƒ…å ±ã¯å„æ–½è¨­ã¸ã”ç¢ºèªãã ã•ã„ã€‚</p>
    <p class="mt-1">Â© 2026 ã¾ãƒ¼ã‚‹æ²–ç¸„</p>
  </footer>

  <!-- â”€â”€ JavaScript â”€â”€ -->
  <script>
    /* =========================================================
       å®šæ•°ãƒ»è¨­å®š
    ========================================================= */

    // ç©´å ´ã‚¹ãƒãƒƒãƒˆä¸€è¦§ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ï¼‰
    const HONESPOT_LIST = [
      {
        name: "åŒ—è°·ç”ºç¾æµœãƒ“ãƒ¼ãƒå‘¨è¾º",
        note: "ã‚†ã„ãƒ¬ãƒ¼ãƒ«ï¼‹ãƒã‚¹åˆ©ç”¨ã§é§è»Šå ´ä¸è¦ã€‚ã‚«ãƒ•ã‚§ã‚‚å……å®Ÿã€‚",
        icon: "ğŸŒŠ",
      },
      {
        name: "æ²–ç¸„å¸‚ã‚³ã‚¶å•†åº—è¡—",
        note: "å€‹æ€§æ´¾ã‚·ãƒ§ãƒƒãƒ—ã‚„åœ°å…ƒé£¯ãŒæ¥½ã—ã‚ã‚‹ç©´å ´ã‚¨ãƒªã‚¢ã€‚ç„¡æ–™é§è»Šå ´ã‚ã‚Šã€‚",
        icon: "ğŸµ",
      },
      {
        name: "å—åŸå¸‚ãƒ»çŸ¥å¿µå²¬å…¬åœ’",
        note: "é’ã„æµ·ã¨ç©ºã‚’ç‹¬ã‚Šå ã‚ã€‚é§è»Šå ´ã¯ç„¡æ–™ã§åºƒã€…ã€‚",
        icon: "ğŸŒ…",
      },
      {
        name: "æµ¦æ·»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ«ï¼ˆãƒ‘ãƒ«ã‚³ã‚·ãƒ†ã‚£æ±å´ï¼‰",
        note: "ãƒ‘ãƒ«ã‚³æœ¬é¤¨ãŒæ··é›‘ä¸­ã§ã‚‚æ±å´ã®ç«‹ä½“é§è»Šå ´ã¯æ¯”è¼ƒçš„ç©ºãå¤šã‚ã€‚",
        icon: "ğŸ…¿ï¸",
      },
      {
        name: "å®œé‡æ¹¾å¸‚ ã¯ã”ã‚ã‚‚å…¬åœ’",
        note: "åœ°å…ƒã®å®¶æ—é€£ã‚Œã«äººæ°—ã€‚å¤§å‹é§è»Šå ´å®Œå‚™ã§ã‚†ã£ãŸã‚Šéã”ã›ã¾ã™ã€‚",
        icon: "ğŸŒ¿",
      },
    ];

    /* =========================================================
       ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â†’ UI ãƒãƒƒãƒ”ãƒ³ã‚°
    ========================================================= */
    function getStatusUI(pct, status) {
      // æ•°å€¤å„ªå…ˆã€ãªã‘ã‚Œã° status æ–‡å­—åˆ—ã§åˆ¤å®š
      const n = (typeof pct === 'number') ? pct : -1;
      const s = status || 'unknown';

      if (n >= 80 || s === 'full' || s === 'almost_full') {
        return {
          label:   n >= 100 || s === 'full' ? 'æº€è»Š' : 'ã»ã¼æº€è»Š',
          color:   'from-red-400 to-coral',
          bg:      'bg-red-50',
          border:  'border-red-200',
          text:    'text-red-600',
          barBg:   'bg-red-400',
          icon:    'ğŸ”´',
          blink:   n >= 100 || s === 'full',
        };
      }
      if (n >= 50 || s === 'crowded') {
        return {
          label:   'æ··é›‘',
          color:   'from-yellow-400 to-amber-400',
          bg:      'bg-amber-50',
          border:  'border-amber-200',
          text:    'text-amber-600',
          barBg:   'bg-amber-400',
          icon:    'ğŸŸ¡',
          blink:   false,
        };
      }
      if (n >= 0 || s === 'available') {
        return {
          label:   'ç©ºãã‚ã‚Š',
          color:   'from-emerald-400 to-leaf',
          bg:      'bg-emerald-50',
          border:  'border-emerald-200',
          text:    'text-emerald-600',
          barBg:   'bg-emerald-400',
          icon:    'ğŸŸ¢',
          blink:   false,
        };
      }
      return {
        label:   'æƒ…å ±ãªã—',
        color:   'from-gray-300 to-gray-400',
        bg:      'bg-gray-50',
        border:  'border-gray-200',
        text:    'text-gray-500',
        barBg:   'bg-gray-300',
        icon:    'âšª',
        blink:   false,
      };
    }

    /* =========================================================
       æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ—¥æœ¬èªï¼‰
    ========================================================= */
    function formatJST(isoStr) {
      try {
        const d = new Date(isoStr);
        return d.toLocaleString('ja-JP', {
          timeZone: 'Asia/Tokyo',
          month: 'long', day: 'numeric',
          hour: '2-digit', minute: '2-digit',
          hour12: false,
        });
      } catch {
        return isoStr;
      }
    }

    /* =========================================================
       ã‚«ãƒ¼ãƒ‰ HTML ç”Ÿæˆ
    ========================================================= */
    function buildCard(mallName, sublabel, emoji, data) {
      const section = (data.sections && data.sections[0]) || {};
      const pct    = section.occupancy_pct;
      const status = section.status;
      const ui     = getStatusUI(pct, status);
      const barPct = typeof pct === 'number' ? Math.min(pct, 100) : 0;
      const method = section.detection_method || '';
      const methodLabel = method === 'ocr' ? 'OCR' : method === 'color' ? 'è‰²åˆ†æ' : '';

      return `
        <div class="card-shadow rounded-3xl overflow-hidden border ${ui.border}">
          <!-- ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¸¯ï¼‰-->
          <div class="bg-gradient-to-r ${ui.color} px-5 py-3 flex items-center gap-2">
            <span class="text-2xl">${emoji}</span>
            <div>
              <p class="text-white text-xs font-semibold opacity-80 leading-none">${sublabel}</p>
              <p class="text-white text-lg font-black leading-tight">${mallName}</p>
            </div>
          </div>

          <!-- ã‚«ãƒ¼ãƒ‰ãƒœãƒ‡ã‚£ -->
          <div class="${ui.bg} px-5 py-5">

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ + æ•°å€¤ -->
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <span class="text-3xl ${ui.blink ? 'blink' : ''}">${ui.icon}</span>
                <span class="${ui.text} text-2xl font-black">${ui.label}</span>
              </div>
              <div class="text-right">
                ${typeof pct === 'number'
                  ? `<span class="${ui.text} text-4xl font-black">${pct}</span>
                     <span class="${ui.text} text-xl font-bold">%</span>`
                  : `<span class="text-gray-400 text-lg font-bold">---</span>`
                }
                <p class="text-gray-400 text-xs">é§è»Šç‡</p>
              </div>
            </div>

            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
            <div class="bg-white/70 rounded-full h-4 overflow-hidden shadow-inner">
              <div class="${ui.barBg} h-full rounded-full fill-bar"
                   style="--target-width:${barPct}%; width:0"></div>
            </div>
            <div class="flex justify-between text-gray-400 text-xs mt-1">
              <span>0%</span>
              <span>50%</span>
              <span>100%</span>
            </div>

            <!-- ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ± -->
            <div class="mt-3 flex items-center justify-between flex-wrap gap-1">
              <p class="text-gray-400 text-xs">
                æœ€çµ‚æ›´æ–°ï¼š
                <span class="text-gray-500 font-semibold">${formatJST(data.fetched_at)}</span>
              </p>
              ${methodLabel
                ? `<span class="bg-white text-gray-400 text-xs px-2 py-0.5 rounded-full border border-gray-200">
                     å–å¾—æ–¹æ³•: ${methodLabel}
                   </span>`
                : ''
              }
            </div>

            ${!data.fetch_ok
              ? `<p class="mt-2 text-red-500 text-xs bg-red-50 border border-red-200 rounded-lg px-3 py-1.5">
                   âš ï¸ å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error_msg || 'è©³ç´°ä¸æ˜'}
                 </p>`
              : ''
            }
          </div>
        </div>
      `;
    }

    /* =========================================================
       ç©´å ´ã‚¹ãƒãƒƒãƒˆã‚¨ãƒªã‚¢ HTML ç”Ÿæˆ
    ========================================================= */
    function buildHoneSpot() {
      const items = HONESPOT_LIST.map(s => `
        <li class="flex items-start gap-3 py-3 border-b border-orange-100 last:border-0">
          <span class="text-2xl flex-shrink-0">${s.icon}</span>
          <div>
            <p class="text-gray-800 font-bold text-base leading-tight">${s.name}</p>
            <p class="text-gray-500 text-sm mt-0.5">${s.note}</p>
          </div>
        </li>
      `).join('');

      return `
        <div class="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200
                    rounded-3xl overflow-hidden card-shadow">
          <div class="bg-gradient-to-r from-orange-400 to-amber-400 px-5 py-4">
            <p class="text-white text-xl font-black">ğŸŒ´ è¿‘ãã®ç©´å ´ã‚¹ãƒãƒƒãƒˆã¸è¡Œãã¾ã›ã‚“ã‹ï¼Ÿ</p>
            <p class="text-orange-100 text-sm mt-0.5">
              ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ«ãŒæ··é›‘ä¸­ã§ã™ã€‚ã‚†ã£ãŸã‚Šéã”ã›ã‚‹å ´æ‰€ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚
            </p>
          </div>
          <ul class="px-5 py-2">
            ${items}
          </ul>
          <p class="text-gray-400 text-xs text-center pb-4">
            â€» æƒ…å ±ã¯å‚è€ƒã§ã™ã€‚ç¾åœ°ã®çŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
          </p>
        </div>
      `;
    }

    /* =========================================================
       ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æç”»ãƒ¡ã‚¤ãƒ³
    ========================================================= */
    async function loadAll() {
      // ã‚¢ã‚¤ã‚³ãƒ³å›è»¢
      const icon = document.getElementById('refreshIcon');
      icon.classList.add('animate-spin');

      // UI ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('loadingArea').classList.remove('hidden');
      document.getElementById('errorArea').classList.add('hidden');
      document.getElementById('cardsArea').classList.add('hidden');
      document.getElementById('honeSpotArea').classList.add('hidden');
      document.getElementById('updatedArea').classList.add('hidden');

      try {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ãŸã‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ä¸
        const ts = `?_=${Date.now()}`;
        const [parcoRes, rycomRes] = await Promise.all([
          fetch(`status.json${ts}`),
          fetch(`rycom_status.json${ts}`),
        ]);

        if (!parcoRes.ok) throw new Error(`status.json ã®å–å¾—å¤±æ•— (HTTP ${parcoRes.status})`);
        if (!rycomRes.ok) throw new Error(`rycom_status.json ã®å–å¾—å¤±æ•— (HTTP ${rycomRes.status})`);

        const parcoData = await parcoRes.json();
        const rycomData = await rycomRes.json();

        // ã‚«ãƒ¼ãƒ‰æç”»
        const cardsArea = document.getElementById('cardsArea');
        cardsArea.innerHTML =
          buildCard('ã‚µãƒ³ã‚¨ãƒ¼æµ¦æ·»è¥¿æµ·å²¸', 'PARCO CITY',   'ğŸ›ï¸', parcoData) +
          buildCard('ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«æ²–ç¸„',   'ãƒ©ã‚¤ã‚«ãƒ ', 'ğŸ¬', rycomData);
        cardsArea.classList.remove('hidden');

        // ä¸¡æ–¹80%ä»¥ä¸Šã‹åˆ¤å®šï¼ˆæ•°å€¤ãŒãªã‘ã‚Œã° status ã§åˆ¤æ–­ï¼‰
        function isCrowded(d) {
          const s = (d.sections && d.sections[0]) || {};
          if (typeof s.occupancy_pct === 'number') return s.occupancy_pct >= 80;
          return s.status === 'full' || s.status === 'almost_full';
        }
        const bothCrowded = isCrowded(parcoData) && isCrowded(rycomData);

        const honeArea = document.getElementById('honeSpotArea');
        if (bothCrowded) {
          honeArea.innerHTML = buildHoneSpot();
          honeArea.classList.remove('hidden');
        } else {
          honeArea.classList.add('hidden');
        }

        // æœ€çµ‚æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸å–å¾—æ™‚åˆ»ï¼‰
        const now = new Date().toLocaleString('ja-JP', {
          timeZone: 'Asia/Tokyo',
          month: 'long', day: 'numeric',
          hour: '2-digit', minute: '2-digit',
          second: '2-digit',
          hour12: false,
        });
        document.getElementById('updatedText').textContent = `ãƒšãƒ¼ã‚¸æ›´æ–°: ${now}`;
        document.getElementById('updatedArea').classList.remove('hidden');

        document.getElementById('loadingArea').classList.add('hidden');

      } catch (err) {
        console.error(err);
        document.getElementById('loadingArea').classList.add('hidden');
        document.getElementById('errorMsg').textContent = err.message;
        document.getElementById('errorArea').classList.remove('hidden');
      } finally {
        icon.classList.remove('animate-spin');
      }
    }

    /* =========================================================
       åˆæœŸå®Ÿè¡Œ & 5åˆ†è‡ªå‹•æ›´æ–°
    ========================================================= */
    loadAll();
    setInterval(loadAll, 5 * 60 * 1000); // 5åˆ†ã”ã¨
  </script>

</body>
</html>
